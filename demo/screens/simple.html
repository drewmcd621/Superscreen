<html>
<head>
  <style>
    body
    {
      margin:0;
    }
  </style>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.6/d3.min.js"></script>
  <script>
  var socket = io();
  $(document).ready(function(){
    var r_name = /\?name=([^&]+)/;
    var match = r_name.exec(window.location.href);

    var name = match[1];
    socket.emit('handshake', "hello I'm " + name);

    socket.on("newObj", function(data){
      if(name == data.name)
      {
        console.log(data);
        blink();

      }
    });

    var h = $("body").height();
    var w = $("body").width();

    var svg = d3.select("body")
                .append("svg")
                .attr("width", w)
                .attr("height", h);

    function Ball(canvass, posX, posY, speedX, speedY) {
      this.dX = speedX;
      this.dY = speedY;
      this.x = posX;
      this.y = posY;
      this.svg = canvass;
      var ballObj = this;
      this.rad = 5;

      this.ball = canvass.append('circle')
                         .attr("r", ballObj.rad)
                         .attr("cx", ballObj.x)
                         .attr("cy", ballObj.y)
                         .style("fill","red");
      this.move = function(){
        ballObj.x += ballObj.dX;
        ballObj.y += ballObj.dY;

        ballObj.ball.attr("cx", ballObj.x)
                    .attr("cy", ballObj.y);
      }

      this.checkWall = function()
      {
        var hsvg = $(ballObj.svg.node()).height();
        var wsvg = $(ballObj.svg.node()).width();

        var dir = null;


        if(ballObj.y - ballObj.rad <= 0)
        {
          dir = "U";
        }
        if(ballObj.y + ballObj.rad >= hsvg)
        {
          dir = "D";
        }

        if(ballObj.x - ballObj.rad <= 0)
        {
          dir = "L"
        }
        if(ballObj.x + ballObj.rad >= wsvg)
        {
          dir = "R";
        }

        return dir;


      }
      this.bounce = function(horizontal)
      {
        if(horizontal)
        {
            ballObj.dX *= -1;
        }
        else
        {
          ballObj.dY *= -1;
        }
      }

      this.delete = function()
      {
        ballObj.ball.remove();
      }
    }

    var balls = [];

    function scaleX(p)
    {
      return p * w;
    }

    function scaleY(p)
    {
      return p * h;
    }

    for (var i = 0; i < 7; i++) {
      balls.push(new Ball(svg, scaleX(Math.random()), scaleY(Math.random()), Math.random()*6 - 3, Math.random()*6 - 3));
    }

    d3.timer(function () {
      for (var i = 0; i < balls.length; ++i) {
            if( ! balls[i] ) continue;
            balls[i].move();
            var wall = balls[i].checkWall();
            if(wall)
            {
              var tempBall = balls[i];
              balls[i] = null;

              var url = "http://flyingkiwibird.com:8085/api/transmit";
              var data = {};
              data["name"] = name;
              data["to"] = wall;
              data["left"] = tempBall.x / w;
              data["top"] = tempBall.y / h;
              data["xspeed"] = tempBall.dX / w;
              data["yspeed"] = tempBall.dY / h;

              $.getJSON(url, data).done(function(data){
                console.log(data);
                if(data.success)
                {
                  if(data.sent)
                  {
                    tempBall.delete();
                    tempBall = null;

                  }
                }
              }).always(function ()
              {
                if(tempBall)
                {
                  if(wall == "D" || wall == "U")
                  {
                    tempBall.bounce(false);
                  }
                  else {
                    tempBall.bounce(true);
                  }
                }
                balls.push(tempBall);
              });
            }
        }
    }, 17); //A delay of 17 is about 60 fps

  });



  </script>
</head>
<body>

</body>
</html>

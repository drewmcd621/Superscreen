<html>
<head>
<style>
body
{
  margin:0;
}
</style>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.6/d3.min.js"></script>
<script>
var socket = io();
$(document).ready(function(){
  var r_name = /\?name=([^&]+)/;
  var match = r_name.exec(window.location.href);

  var name = match[1];
  socket.emit('handshake', "hello I'm " + name);



  var h = $("body").height();
  var w = $("body").width();

  var svg = d3.select("body")
  .append("svg")
  .attr("width", w)
  .attr("height", h);

  function Ball(canvass, posX, posY, speedX, speedY, color) {
    this.dX = speedX;
    this.dY = speedY;
    this.x = posX;
    this.y = posY;
    this.svg = canvass;
    this.hold = false;
    var ballObj = this;
    this.rad = 10;

    this.ball = canvass.append('circle')
    .attr("r", ballObj.rad)
    .attr("cx", ballObj.x)
    .attr("cy", ballObj.y)
    .style("fill",color);
    this.move = function(){
      if(ballObj.hold) return;
      ballObj.x += ballObj.dX;
      ballObj.y += ballObj.dY;

      ballObj.ball.attr("cx", ballObj.x)
      .attr("cy", ballObj.y);
    }

    this.checkWall = function()
    {
      if(ballObj.hold) return;
      var hsvg = $(ballObj.svg.node()).height();
      var wsvg = $(ballObj.svg.node()).width();

      var dir = null;


      if(ballObj.y - ballObj.rad <= 0)
      {
        //ballObj.dY = Math.abs(ballObj.dY);
        ballObj.y = ballObj.rad + 15;
        dir = "U";
      }
      if(ballObj.y + ballObj.rad >= hsvg)
      {
        //ballObj.dY = -1 * Math.abs(ballObj.dY);
        ballObj.y = hsvg - (ballObj.rad  + 15);
        dir = "D";
      }

      if(ballObj.x - ballObj.rad <= 0)
      {
        //ballObj.dX = Math.abs(ballObj.dX);
        ballObj.x = ballObj.rad + 3;
        dir = "L"
      }
      if(ballObj.x + ballObj.rad >= wsvg)
      {
        //ballObj.dX = -1 * Math.abs(ballObj.dX);
        ballObj.x = wsvg - (ballObj.rad + 3);
        dir = "R";
      }


      ballObj.ball.attr("cx", ballObj.x)
      .attr("cy", ballObj.y);
      return dir;


    }

    this.bounce = function(wall)
    {
      if(wall == "U")
      {
        ballObj.dY = Math.abs(ballObj.dY);
      }
      else if (wall == "D") {
        ballObj.dY = -1 * Math.abs(ballObj.dY);
      }
      else if (wall == "L") {
        ballObj.dX = Math.abs(ballObj.dX);
      }
      else if (wall == "R") {
        ballObj.dX = -1 * Math.abs(ballObj.dX);
      }
    }

    this.delete = function()
    {
      ballObj.ball.remove();
    }
  }

  var balls = [];

  function scaleX(p)
  {
    return p * w;
  }

  function scaleY(p)
  {
    return p * h;
  }

  for (var i = 0; i < 1; i++) {
    balls.push(new Ball(svg, scaleX(Math.random()), scaleY(Math.random()), 1, 2, "red"));
  }

  socket.on("newObj", function(data){
    if(name == data.name)
    {
      var l = balls.push(new Ball(svg, scaleX(data.object.left), scaleY(data.object.top),scaleX(data.object.xspeed), scaleY(data.object.yspeed), "blue"));
      balls[l-1].move(); //Move the ball a step on load
    }
  });

  d3.timer(function () {
    for (var i = balls.length -1; i >= 0; --i) {
      if(! balls[i]) continue;
      if(balls[i].hold) continue;
      balls[i].move();
      var wall = balls[i].checkWall();
      if(wall)
      {
        balls[i].hold = true; //Hold the ball in place

        var thisBall = balls[i];
        var idx = i;

        var url = "http://flyingkiwibird.com:8085/api/transmit";
        var data = {};
        data["name"] = name;
        data["to"] = wall;
        data["left"] = thisBall.x / w;
        data["top"] = thisBall.y / h;
        data["xspeed"] = thisBall.dX / w;
        data["yspeed"] = thisBall.dY / h;

        thisBall.bounce(wall);



        $.getJSON(url, data).done(function(data){
          console.log(data);
          if(data.success)
          {
            if(data.sent)
            {
              thisBall.delete();
              balls[idx] = null;  //Ball is on another screen now...
            }
          }
        }).always(function(){
          if(thisBall)
          {

            thisBall.hold = false;

          }
        });
      }
    }
    //Remove nulls
    for (var i = balls.length -1; i >= 0; --i) {
      if(! balls[i])
      {
        balls.splice(i, 1);
      }
    }
  }, 17); //A delay of 17ms is about 60 fps

});



</script>
</head>
<body>

</body>
</html>
